name: Release

on:
    push:
        tags:
            - "v*"

env:
    CARGO_TERM_COLOR: always

jobs:
    create-release:
        runs-on: ubuntu-latest
        outputs:
            tag_name: ${{ steps.tag.outputs.tag_name }}
        steps:
            - uses: actions/checkout@v5

            - name: Get tag name
              id: tag
              run: echo "tag_name=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

            - name: Create Release
              run: |
                  gh release create ${{ steps.tag.outputs.tag_name }} \
                    --title "Release ${{ steps.tag.outputs.tag_name }}" \
                    --generate-notes \
                    --draft=false \
                    --prerelease=false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    build-nix:
        needs: create-release
        strategy:
            fail-fast: false
            matrix:
                include:
                    - os: ubuntu-latest
                      target: x86_64-unknown-linux-gnu
                      artifact_name: linux-x86_64
                      outputs: createcog-musl tiles2raster-musl tileserver-musl
                    - os: macos-latest
                      target: aarch64-apple-darwin
                      artifact_name: macos-arm64
                      outputs: createcog tiles2raster tileserver

        runs-on: ${{ matrix.os }}

        steps:
            - uses: actions/checkout@v5
            - uses: cachix/install-nix-action@v31

            - name: Install devenv.sh
              run: nix profile install nixpkgs#devenv

            - name: Build release binaries
              run: |
                  for output in ${{ matrix.outputs }}; do
                    echo "Building $output..."
                    nix build .#$output
                  done

            - name: Create archives and upload
              run: |
                  # Map output names to tool names (remove -musl suffix for filenames)
                  for output in ${{ matrix.outputs }}; do
                    tool=$(echo $output | sed 's/-musl$//')

                    # Create archive
                    mkdir -p ${tool}-temp
                    cp result/bin/${tool} ${tool}-temp/ 2>/dev/null || cp result-*/bin/${tool} ${tool}-temp/ || echo "Warning: Could not find binary for $tool"

                    if [ -f ${tool}-temp/${tool} ]; then
                      tar -czf ${tool}-${{ matrix.artifact_name }}.tar.gz -C ${tool}-temp ${tool}
                      rm -rf ${tool}-temp

                      # Upload to release
                      gh release upload ${{ needs.create-release.outputs.tag_name }} ${tool}-${{ matrix.artifact_name }}.tar.gz
                    fi

                    # Clean up nix result symlinks
                    rm -f result result-*
                  done
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    build-windows:
        needs: create-release
        runs-on: windows-2025

        steps:
            - uses: actions/checkout@v5

            - uses: jdx/mise-action@v3
              with:
                  cache_key: "mise-{{platform}}-{{file_hash}}"

            - name: Cache vcpkg packages
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cache/vcpkg
                      ~/AppData/Local/vcpkg/archives
                      ./target/vcpkg
                  key: windows-x86_64-pc-windows-msvc-${{ hashFiles('Cargo.toml') }}
                  restore-keys: |
                      windows-x86_64-pc-windows-msvc-
                      windows-

            - name: Set VCPKG environment variables
              run: |
                  echo "VCPKG_DEFAULT_TRIPLET=x64-windows-static-release" >> $GITHUB_ENV
                  echo "VCPKG_DEFAULT_HOST_TRIPLET=x64-windows-static-release" >> $GITHUB_ENV
              shell: bash

            - name: Bootstrap vcpkg dependencies
              run: mise -E vcpkg run bootstrap --target x86_64-pc-windows-msvc --triplet x64-windows-static-release

            - name: Build tools for release
              run: mise exec -E vcpkg cargo -- cargo build --release --config .cargo/config.vcpkg.toml --target x86_64-pc-windows-msvc -p createcog -p tiles2raster -p tileserver

            - name: Create archives and upload
              run: |
                  # Create individual archives for each tool
                  for tool in createcog tiles2raster tileserver; do
                    mkdir -p ${tool}-temp
                    cp target/x86_64-pc-windows-msvc/release/${tool}.exe ${tool}-temp/
                    cd ${tool}-temp
                    7z a ../${tool}-windows-x86_64.zip ${tool}.exe
                    cd ..
                    rm -rf ${tool}-temp
                    gh release upload ${{ needs.create-release.outputs.tag_name }} ${tool}-windows-x86_64.zip
                  done
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              shell: bash
